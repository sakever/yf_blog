<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>线程池作用、用法以及原理 | sakever 的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/yf_blog/blogger_icon.ico">
    <meta name="description" content="记录学习到的知识">
    <meta name="theme-color" content="#14204193">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <link rel="preload" href="/yf_blog/assets/css/0.styles.743290fa.css" as="style"><link rel="preload" href="/yf_blog/assets/js/app.63605832.js" as="script"><link rel="preload" href="/yf_blog/assets/js/3.86e8edc4.js" as="script"><link rel="preload" href="/yf_blog/assets/js/2.e5572c9a.js" as="script"><link rel="preload" href="/yf_blog/assets/js/158.608e9bf5.js" as="script"><link rel="prefetch" href="/yf_blog/assets/js/1.368c97ab.js"><link rel="prefetch" href="/yf_blog/assets/js/10.3d1375a6.js"><link rel="prefetch" href="/yf_blog/assets/js/100.8ab6a130.js"><link rel="prefetch" href="/yf_blog/assets/js/101.ce91e2df.js"><link rel="prefetch" href="/yf_blog/assets/js/102.48b16c3f.js"><link rel="prefetch" href="/yf_blog/assets/js/103.a902dfa0.js"><link rel="prefetch" href="/yf_blog/assets/js/104.a1a8279b.js"><link rel="prefetch" href="/yf_blog/assets/js/105.cbd72fe8.js"><link rel="prefetch" href="/yf_blog/assets/js/106.93fc186b.js"><link rel="prefetch" href="/yf_blog/assets/js/107.8d859c7a.js"><link rel="prefetch" href="/yf_blog/assets/js/108.4687f40b.js"><link rel="prefetch" href="/yf_blog/assets/js/109.ce754f1e.js"><link rel="prefetch" href="/yf_blog/assets/js/11.a58d4534.js"><link rel="prefetch" href="/yf_blog/assets/js/110.a291ddc7.js"><link rel="prefetch" href="/yf_blog/assets/js/111.1a7acbef.js"><link rel="prefetch" href="/yf_blog/assets/js/112.6502b552.js"><link rel="prefetch" href="/yf_blog/assets/js/113.218b6264.js"><link rel="prefetch" href="/yf_blog/assets/js/114.e3dee2de.js"><link rel="prefetch" href="/yf_blog/assets/js/115.2f083c77.js"><link rel="prefetch" href="/yf_blog/assets/js/116.4814a44b.js"><link rel="prefetch" href="/yf_blog/assets/js/117.b1c4e8eb.js"><link rel="prefetch" href="/yf_blog/assets/js/118.5a218e50.js"><link rel="prefetch" href="/yf_blog/assets/js/119.176c22b0.js"><link rel="prefetch" href="/yf_blog/assets/js/12.c82c7c16.js"><link rel="prefetch" href="/yf_blog/assets/js/120.58c46f57.js"><link rel="prefetch" href="/yf_blog/assets/js/121.74ef3c83.js"><link rel="prefetch" href="/yf_blog/assets/js/122.f0f792f4.js"><link rel="prefetch" href="/yf_blog/assets/js/123.c51b1b10.js"><link rel="prefetch" href="/yf_blog/assets/js/124.1c9fc4fa.js"><link rel="prefetch" href="/yf_blog/assets/js/125.af8f2ba2.js"><link rel="prefetch" href="/yf_blog/assets/js/126.380c77c2.js"><link rel="prefetch" href="/yf_blog/assets/js/127.fd8ac9ac.js"><link rel="prefetch" href="/yf_blog/assets/js/128.48af7da5.js"><link rel="prefetch" href="/yf_blog/assets/js/129.fc0499e1.js"><link rel="prefetch" href="/yf_blog/assets/js/13.ea6b5163.js"><link rel="prefetch" href="/yf_blog/assets/js/130.bad18f39.js"><link rel="prefetch" href="/yf_blog/assets/js/131.a1818a91.js"><link rel="prefetch" href="/yf_blog/assets/js/132.3f5ee232.js"><link rel="prefetch" href="/yf_blog/assets/js/133.4a01df45.js"><link rel="prefetch" href="/yf_blog/assets/js/134.a4ccd439.js"><link rel="prefetch" href="/yf_blog/assets/js/135.ef246441.js"><link rel="prefetch" href="/yf_blog/assets/js/136.a7b98da7.js"><link rel="prefetch" href="/yf_blog/assets/js/137.d4d0e297.js"><link rel="prefetch" href="/yf_blog/assets/js/138.7fea3536.js"><link rel="prefetch" href="/yf_blog/assets/js/139.2f15b786.js"><link rel="prefetch" href="/yf_blog/assets/js/14.4770d6f2.js"><link rel="prefetch" href="/yf_blog/assets/js/140.05f0838a.js"><link rel="prefetch" href="/yf_blog/assets/js/141.cf6396cf.js"><link rel="prefetch" href="/yf_blog/assets/js/142.0091b89f.js"><link rel="prefetch" href="/yf_blog/assets/js/143.e547ea90.js"><link rel="prefetch" href="/yf_blog/assets/js/144.48cde487.js"><link rel="prefetch" href="/yf_blog/assets/js/145.e30f67ce.js"><link rel="prefetch" href="/yf_blog/assets/js/146.2201caf0.js"><link rel="prefetch" href="/yf_blog/assets/js/147.7ad8534b.js"><link rel="prefetch" href="/yf_blog/assets/js/148.b4750145.js"><link rel="prefetch" href="/yf_blog/assets/js/149.c35ea20a.js"><link rel="prefetch" href="/yf_blog/assets/js/15.52c2bc6f.js"><link rel="prefetch" href="/yf_blog/assets/js/150.b6a06c27.js"><link rel="prefetch" href="/yf_blog/assets/js/151.612d8d8a.js"><link rel="prefetch" href="/yf_blog/assets/js/152.f8188e8e.js"><link rel="prefetch" href="/yf_blog/assets/js/153.d23a8aee.js"><link rel="prefetch" href="/yf_blog/assets/js/154.bbec89db.js"><link rel="prefetch" href="/yf_blog/assets/js/155.b6bacdd0.js"><link rel="prefetch" href="/yf_blog/assets/js/156.894d14c6.js"><link rel="prefetch" href="/yf_blog/assets/js/157.42993cb2.js"><link rel="prefetch" href="/yf_blog/assets/js/159.d13c9800.js"><link rel="prefetch" href="/yf_blog/assets/js/16.aa789364.js"><link rel="prefetch" href="/yf_blog/assets/js/160.e91645e7.js"><link rel="prefetch" href="/yf_blog/assets/js/161.e0b1cfb8.js"><link rel="prefetch" href="/yf_blog/assets/js/162.03c9592c.js"><link rel="prefetch" href="/yf_blog/assets/js/163.66db9e4b.js"><link rel="prefetch" href="/yf_blog/assets/js/164.4f7d807b.js"><link rel="prefetch" href="/yf_blog/assets/js/165.27a59a3e.js"><link rel="prefetch" href="/yf_blog/assets/js/166.6caac53c.js"><link rel="prefetch" href="/yf_blog/assets/js/167.e76a183f.js"><link rel="prefetch" href="/yf_blog/assets/js/168.11f7e34c.js"><link rel="prefetch" href="/yf_blog/assets/js/169.6a6bd39a.js"><link rel="prefetch" href="/yf_blog/assets/js/17.05e8b595.js"><link rel="prefetch" href="/yf_blog/assets/js/170.95f4390c.js"><link rel="prefetch" href="/yf_blog/assets/js/171.9212ddb1.js"><link rel="prefetch" href="/yf_blog/assets/js/172.c04c0f71.js"><link rel="prefetch" href="/yf_blog/assets/js/173.bf5b9980.js"><link rel="prefetch" href="/yf_blog/assets/js/174.56b689bb.js"><link rel="prefetch" href="/yf_blog/assets/js/175.63287e5f.js"><link rel="prefetch" href="/yf_blog/assets/js/176.e59dbfc0.js"><link rel="prefetch" href="/yf_blog/assets/js/177.a932f1c3.js"><link rel="prefetch" href="/yf_blog/assets/js/178.7fbba2c8.js"><link rel="prefetch" href="/yf_blog/assets/js/179.cecd807a.js"><link rel="prefetch" href="/yf_blog/assets/js/18.ff40c92f.js"><link rel="prefetch" href="/yf_blog/assets/js/180.0d271178.js"><link rel="prefetch" href="/yf_blog/assets/js/181.065bb3ce.js"><link rel="prefetch" href="/yf_blog/assets/js/182.b4d18f3b.js"><link rel="prefetch" href="/yf_blog/assets/js/183.6b55ee3b.js"><link rel="prefetch" href="/yf_blog/assets/js/184.e3e794b9.js"><link rel="prefetch" href="/yf_blog/assets/js/185.816d101a.js"><link rel="prefetch" href="/yf_blog/assets/js/186.827f403c.js"><link rel="prefetch" href="/yf_blog/assets/js/187.6919391d.js"><link rel="prefetch" href="/yf_blog/assets/js/188.0c3aca7a.js"><link rel="prefetch" href="/yf_blog/assets/js/189.0f1ba010.js"><link rel="prefetch" href="/yf_blog/assets/js/19.ae59133e.js"><link rel="prefetch" href="/yf_blog/assets/js/190.9d63780f.js"><link rel="prefetch" href="/yf_blog/assets/js/191.28527e1d.js"><link rel="prefetch" href="/yf_blog/assets/js/192.adfd3c22.js"><link rel="prefetch" href="/yf_blog/assets/js/193.acdd3225.js"><link rel="prefetch" href="/yf_blog/assets/js/194.0077498c.js"><link rel="prefetch" href="/yf_blog/assets/js/195.a9163d7a.js"><link rel="prefetch" href="/yf_blog/assets/js/196.3a5d4afb.js"><link rel="prefetch" href="/yf_blog/assets/js/197.f1730343.js"><link rel="prefetch" href="/yf_blog/assets/js/198.49ea862a.js"><link rel="prefetch" href="/yf_blog/assets/js/199.865abc5d.js"><link rel="prefetch" href="/yf_blog/assets/js/20.7b86335d.js"><link rel="prefetch" href="/yf_blog/assets/js/21.f3f5c621.js"><link rel="prefetch" href="/yf_blog/assets/js/22.e0a1f5a4.js"><link rel="prefetch" href="/yf_blog/assets/js/23.7eabb604.js"><link rel="prefetch" href="/yf_blog/assets/js/24.8a88487b.js"><link rel="prefetch" href="/yf_blog/assets/js/25.59e0b3d9.js"><link rel="prefetch" href="/yf_blog/assets/js/26.a620c3de.js"><link rel="prefetch" href="/yf_blog/assets/js/27.5ab2aa34.js"><link rel="prefetch" href="/yf_blog/assets/js/28.1d4aac9c.js"><link rel="prefetch" href="/yf_blog/assets/js/29.468a0343.js"><link rel="prefetch" href="/yf_blog/assets/js/30.2d61f6ce.js"><link rel="prefetch" href="/yf_blog/assets/js/31.1b04d40c.js"><link rel="prefetch" href="/yf_blog/assets/js/32.72792376.js"><link rel="prefetch" href="/yf_blog/assets/js/33.4d09633e.js"><link rel="prefetch" href="/yf_blog/assets/js/34.06cff91e.js"><link rel="prefetch" href="/yf_blog/assets/js/35.dbf9d27d.js"><link rel="prefetch" href="/yf_blog/assets/js/36.b4571a58.js"><link rel="prefetch" href="/yf_blog/assets/js/37.f102a4ac.js"><link rel="prefetch" href="/yf_blog/assets/js/38.6f5eb637.js"><link rel="prefetch" href="/yf_blog/assets/js/39.7c425583.js"><link rel="prefetch" href="/yf_blog/assets/js/4.631c4c1e.js"><link rel="prefetch" href="/yf_blog/assets/js/40.7d392773.js"><link rel="prefetch" href="/yf_blog/assets/js/41.8313ff7d.js"><link rel="prefetch" href="/yf_blog/assets/js/42.96b7665a.js"><link rel="prefetch" href="/yf_blog/assets/js/43.9d2a2859.js"><link rel="prefetch" href="/yf_blog/assets/js/44.46b66e7c.js"><link rel="prefetch" href="/yf_blog/assets/js/45.ada8184c.js"><link rel="prefetch" href="/yf_blog/assets/js/46.4032b0a2.js"><link rel="prefetch" href="/yf_blog/assets/js/47.38de3ddf.js"><link rel="prefetch" href="/yf_blog/assets/js/48.917e2eff.js"><link rel="prefetch" href="/yf_blog/assets/js/49.680c9c42.js"><link rel="prefetch" href="/yf_blog/assets/js/5.e4024f1e.js"><link rel="prefetch" href="/yf_blog/assets/js/50.2497b896.js"><link rel="prefetch" href="/yf_blog/assets/js/51.5f26e401.js"><link rel="prefetch" href="/yf_blog/assets/js/52.298a4a18.js"><link rel="prefetch" href="/yf_blog/assets/js/53.c1795ab8.js"><link rel="prefetch" href="/yf_blog/assets/js/54.97009233.js"><link rel="prefetch" href="/yf_blog/assets/js/55.42977e4a.js"><link rel="prefetch" href="/yf_blog/assets/js/56.567acf82.js"><link rel="prefetch" href="/yf_blog/assets/js/57.d9fcc933.js"><link rel="prefetch" href="/yf_blog/assets/js/58.945bcf67.js"><link rel="prefetch" href="/yf_blog/assets/js/59.341d18df.js"><link rel="prefetch" href="/yf_blog/assets/js/6.e0040f07.js"><link rel="prefetch" href="/yf_blog/assets/js/60.e0432806.js"><link rel="prefetch" href="/yf_blog/assets/js/61.a85f9f24.js"><link rel="prefetch" href="/yf_blog/assets/js/62.22b038af.js"><link rel="prefetch" href="/yf_blog/assets/js/63.8826ac02.js"><link rel="prefetch" href="/yf_blog/assets/js/64.3f4494e9.js"><link rel="prefetch" href="/yf_blog/assets/js/65.75e8b993.js"><link rel="prefetch" href="/yf_blog/assets/js/66.7d4f67dd.js"><link rel="prefetch" href="/yf_blog/assets/js/67.86828624.js"><link rel="prefetch" href="/yf_blog/assets/js/68.36008882.js"><link rel="prefetch" href="/yf_blog/assets/js/69.3ce28c42.js"><link rel="prefetch" href="/yf_blog/assets/js/70.4f2231cc.js"><link rel="prefetch" href="/yf_blog/assets/js/71.6d51691c.js"><link rel="prefetch" href="/yf_blog/assets/js/72.a25d48b3.js"><link rel="prefetch" href="/yf_blog/assets/js/73.19df6a84.js"><link rel="prefetch" href="/yf_blog/assets/js/74.2f3408d4.js"><link rel="prefetch" href="/yf_blog/assets/js/75.330d3a09.js"><link rel="prefetch" href="/yf_blog/assets/js/76.73237782.js"><link rel="prefetch" href="/yf_blog/assets/js/77.70f31571.js"><link rel="prefetch" href="/yf_blog/assets/js/78.06fbf21d.js"><link rel="prefetch" href="/yf_blog/assets/js/79.b4a4692b.js"><link rel="prefetch" href="/yf_blog/assets/js/80.733d21da.js"><link rel="prefetch" href="/yf_blog/assets/js/81.8bef16b8.js"><link rel="prefetch" href="/yf_blog/assets/js/82.1b50236f.js"><link rel="prefetch" href="/yf_blog/assets/js/83.5d5cb774.js"><link rel="prefetch" href="/yf_blog/assets/js/84.f3011a69.js"><link rel="prefetch" href="/yf_blog/assets/js/85.3d2cca7e.js"><link rel="prefetch" href="/yf_blog/assets/js/86.927287d2.js"><link rel="prefetch" href="/yf_blog/assets/js/87.6a4f4c5a.js"><link rel="prefetch" href="/yf_blog/assets/js/88.0c75d3ad.js"><link rel="prefetch" href="/yf_blog/assets/js/89.79b7de7e.js"><link rel="prefetch" href="/yf_blog/assets/js/9.77d321d8.js"><link rel="prefetch" href="/yf_blog/assets/js/90.2bbcfb51.js"><link rel="prefetch" href="/yf_blog/assets/js/91.e328fc76.js"><link rel="prefetch" href="/yf_blog/assets/js/92.6c98c7e9.js"><link rel="prefetch" href="/yf_blog/assets/js/93.40bc54a9.js"><link rel="prefetch" href="/yf_blog/assets/js/94.ba7852f9.js"><link rel="prefetch" href="/yf_blog/assets/js/95.43536d3a.js"><link rel="prefetch" href="/yf_blog/assets/js/96.58641450.js"><link rel="prefetch" href="/yf_blog/assets/js/97.74beaa58.js"><link rel="prefetch" href="/yf_blog/assets/js/98.db6d98f0.js"><link rel="prefetch" href="/yf_blog/assets/js/99.465d49b5.js"><link rel="prefetch" href="/yf_blog/assets/js/vendors~docsearch.6de48227.js">
    <link rel="stylesheet" href="/yf_blog/assets/css/0.styles.743290fa.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/yf_blog/" class="home-link router-link-active"><!----> <span class="site-name">sakever 的博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/yf_blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/yf_blog/_posts/" class="nav-link">博客</a></div><div class="nav-item"><a href="/yf_blog/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/yf_blog/tags/" class="nav-link">标签</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/yf_blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/yf_blog/_posts/" class="nav-link">博客</a></div><div class="nav-item"><a href="/yf_blog/categories/" class="nav-link">分类</a></div><div class="nav-item"><a href="/yf_blog/tags/" class="nav-link">标签</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>AI</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/63c823/" class="sidebar-link">Agent 工程架构</a></li><li><a href="/yf_blog/pages/22c1e5/" class="sidebar-link">LLM 相关内容</a></li><li><a href="/yf_blog/pages/28b01b/" class="sidebar-link">NLP 相关知识</a></li><li><a href="/yf_blog/pages/8b625a/" class="sidebar-link">windows 下 ollama 迁移到 D 盘</a></li><li><a href="/yf_blog/pages/be0497/" class="sidebar-link">如何编写 Prompt</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>架构设计</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/45925a/" class="sidebar-link">DDD 架构学习笔记</a></li><li><a href="/yf_blog/pages/bbf9b3/" class="sidebar-link">Java 常用的规则引擎</a></li><li><a href="/yf_blog/pages/105dc4/" class="sidebar-link">MVC 架构学习笔记</a></li><li><a href="/yf_blog/pages/2777d6/" class="sidebar-link">三高问题下的系统优化</a></li><li><a href="/yf_blog/pages/ab7e74/" class="sidebar-link">为什么要打日志？怎么打日志？打什么日志？</a></li><li><a href="/yf_blog/pages/1ac875/" class="sidebar-link">从 ACID 到 BASE 事务处理的实现</a></li><li><a href="/yf_blog/pages/879596/" class="sidebar-link">代码整洁之道</a></li><li><a href="/yf_blog/pages/74cfcb/" class="sidebar-link">抽象方法与设计模式</a></li><li><a href="/yf_blog/pages/6c660c/" class="sidebar-link">分布式架构的观测</a></li><li><a href="/yf_blog/pages/221c1a/" class="sidebar-link">关于分布式系统 RPC 中高可用功能的实现</a></li><li><a href="/yf_blog/pages/ea519f/" class="sidebar-link">用低内存处理大量数据</a></li><li><a href="/yf_blog/pages/b8fe3b/" class="sidebar-link">权限系统设计</a></li><li><a href="/yf_blog/pages/7939ca/" class="sidebar-link">设计模式——过滤器模式在 Spring 中的实践</a></li><li><a href="/yf_blog/pages/7897bf/" class="sidebar-link">状态模式</a></li><li><a href="/yf_blog/pages/e27c25/" class="sidebar-link">设计模式——策略模式</a></li><li><a href="/yf_blog/pages/a30e71/" class="sidebar-link">运维监控常见指标含义</a></li><li><a href="/yf_blog/pages/c7d86e/" class="sidebar-link">集群间数据同步的目的</a></li><li><a href="/yf_blog/pages/bbdd09/" class="sidebar-link">权限系统设计</a></li><li><a href="/yf_blog/pages/fc2dab/" class="sidebar-link">统一结果返回</a></li><li><a href="/yf_blog/pages/a000a1/" class="sidebar-link">参数校验与异常处理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>计算机基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/108bfe/" class="sidebar-link">Hex 和 Base64 编码</a></li><li><a href="/yf_blog/pages/62ed4b/" class="sidebar-link">XML 的使用</a></li><li><a href="/yf_blog/pages/b8a309/" class="sidebar-link">ffmpeg 的安装以及实现音频切分功能</a></li><li><a href="/yf_blog/pages/1090e1/" class="sidebar-link">操作系统 IO 相关知识</a></li><li><a href="/yf_blog/pages/43bc49/" class="sidebar-link">操作系统学习笔记</a></li><li><a href="/yf_blog/pages/eae7fa/" class="sidebar-link">正则表达式相关概念</a></li><li><a href="/yf_blog/pages/a1ee10/" class="sidebar-link">程序的机器级表示</a></li><li><a href="/yf_blog/pages/3715e4/" class="sidebar-link">音频文件基础</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/ba6f43/" class="sidebar-link">动态规划算法学习笔记</a></li><li><a href="/yf_blog/pages/3749e9/" class="sidebar-link">基于比较的排序算法的最坏情况下的最优下界为什么是O(nlogn)</a></li><li><a href="/yf_blog/pages/dbb631/" class="sidebar-link">算法导论第一部分学习笔记</a></li><li><a href="/yf_blog/pages/28b48c/" class="sidebar-link">算法导论第二部分排序学习笔记</a></li><li><a href="/yf_blog/pages/abaa8b/" class="sidebar-link">集合与数据结构学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>开发工具</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/86bf03/" class="sidebar-link">IDEA 常用快捷键以及调试</a></li><li><a href="/yf_blog/pages/918b39/" class="sidebar-link">IDEA 插件推荐</a></li><li><a href="/yf_blog/pages/24df74/" class="sidebar-link">Shell 脚本</a></li><li><a href="/yf_blog/pages/af8a9d/" class="sidebar-link">excel 关于 =vlookup 的用法</a></li><li><a href="/yf_blog/pages/b102e6/" class="sidebar-link">git 的学习以及使用</a></li><li><a href="/yf_blog/pages/8966d7/" class="sidebar-link">如何画时序图、流程图、状态流转图</a></li><li><a href="/yf_blog/pages/852119/" class="sidebar-link">swagger 的使用</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>分布式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/925a62/" class="sidebar-link">Dubbo 基础概念</a></li><li><a href="/yf_blog/pages/13cb16/" class="sidebar-link">Gossip 协议</a></li><li><a href="/yf_blog/pages/b5354a/" class="sidebar-link">Protobuf 通信协议</a></li><li><a href="/yf_blog/pages/3ad6cc/" class="sidebar-link">Zookeeper 基础学习</a></li><li><a href="/yf_blog/pages/9762c0/" class="sidebar-link">nginx 学习笔记</a></li><li><a href="/yf_blog/pages/d289c6/" class="sidebar-link">分布式 id</a></li><li><a href="/yf_blog/pages/a50c51/" class="sidebar-link">分布式一致性算法</a></li><li><a href="/yf_blog/pages/28a595/" class="sidebar-link">分布式缓存相关问题</a></li><li><a href="/yf_blog/pages/f44f2b/" class="sidebar-link">分布式集群理论和分布式事务协议</a></li><li><a href="/yf_blog/pages/20017f/" class="sidebar-link">初步了解 docker</a></li><li><a href="/yf_blog/pages/aba4a1/" class="sidebar-link">访问远程服务</a></li><li><a href="/yf_blog/pages/5fa107/" class="sidebar-link">详解 Spring Cloud</a></li><li><a href="/yf_blog/pages/934661/" class="sidebar-link">负载均衡 Load Balancing</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/976414/" class="sidebar-link">GitHub Pages 部署教程</a></li><li><a href="/yf_blog/pages/4d4c8e/" class="sidebar-link">Vercel 部署教程</a></li><li><a href="/yf_blog/pages/e7adfb/" class="sidebar-link">VuePress 博客搭建指南</a></li><li><a href="/yf_blog/pages/752545/" class="sidebar-link">vue-admin-template 简单使用</a></li><li><a href="/yf_blog/pages/c0290c/" class="sidebar-link">简单了解前端页面开发</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>金融</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/935a0c/" class="sidebar-link">基础的金融知识</a></li><li><a href="/yf_blog/pages/a213dc/" class="sidebar-link">基金与股票</a></li><li><a href="/yf_blog/pages/40b4be/" class="sidebar-link">聊聊价值投资</a></li><li><a href="/yf_blog/pages/76c0e6/" class="sidebar-link">股票技术面</a></li><li><a href="/yf_blog/pages/413621/" class="sidebar-link">股票技术面——盘口</a></li><li><a href="/yf_blog/pages/5824d7/" class="sidebar-link">股票技术面——量价关系</a></li><li><a href="/yf_blog/pages/dedfe1/" class="sidebar-link">韭菜的自我总结</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/6ff481/" class="sidebar-link">CompletableFuture 相关用法</a></li><li><a href="/yf_blog/pages/bbf44a/" class="sidebar-link">CompletableFuture 源码浅要阅读</a></li><li><a href="/yf_blog/pages/ba0a81/" class="sidebar-link">FutureTask 源码阅读</a></li><li><a href="/yf_blog/pages/17128c/" class="sidebar-link">Guava 常用 API</a></li><li><a href="/yf_blog/pages/109193/" class="sidebar-link">Guava 源码阅读：Multimap 相关</a></li><li><a href="/yf_blog/pages/4626f4/" class="sidebar-link">Jackson 的各种使用</a></li><li><a href="/yf_blog/pages/e9fc7e/" class="sidebar-link">Java Http 访问框架</a></li><li><a href="/yf_blog/pages/a61154/" class="sidebar-link">Java Stream 的使用</a></li><li><a href="/yf_blog/pages/56bb4f/" class="sidebar-link">Java 中关于字符串处理的常用方法</a></li><li><a href="/yf_blog/pages/1fd7ef/" class="sidebar-link">Java 中强、软、弱、虚引用</a></li><li><a href="/yf_blog/pages/284a21/" class="sidebar-link">Java 图片文件上传下载处理</a></li><li><a href="/yf_blog/pages/43c23b/" class="sidebar-link">Java 序列化</a></li><li><a href="/yf_blog/pages/801a08/" class="sidebar-link">Java 异常</a></li><li><a href="/yf_blog/pages/009ad1/" class="sidebar-link">Java 的 Excel 相关操作</a></li><li><a href="/yf_blog/pages/c3a732/" class="sidebar-link">Java 语法糖</a></li><li><a href="/yf_blog/pages/af756f/" class="sidebar-link">Java8 新特性</a></li><li><a href="/yf_blog/pages/107d37/" class="sidebar-link">JAVA 枚举的基础和原理</a></li><li><a href="/yf_blog/pages/6cbe96/" class="sidebar-link">JAVA 注解小结</a></li><li><a href="/yf_blog/pages/6d50a7/" class="sidebar-link">Scanner 的各种用法</a></li><li><a href="/yf_blog/pages/bd3431/" class="sidebar-link">Servlet 学习笔记</a></li><li><a href="/yf_blog/pages/51d134/" class="sidebar-link">String、StringBuffer、StringBuilder 学习笔记</a></li><li><a href="/yf_blog/pages/8c9025/" class="sidebar-link">反射学习笔记</a></li><li><a href="/yf_blog/pages/b3b4c7/" class="sidebar-link">如何使用 lambda 表达式实现排序</a></li><li><a href="/yf_blog/pages/1571c7/" class="sidebar-link">对象之间的映射与转换</a></li><li><a href="/yf_blog/pages/740f50/" class="sidebar-link">泛型相关概念</a></li><li><a href="/yf_blog/pages/43f25c/" class="sidebar-link">java 基础知识</a></li><li><a href="/yf_blog/pages/052c29/" class="sidebar-link">java 的常见性能问题分析以及出现场景</a></li><li><a href="/yf_blog/pages/439d72/" class="sidebar-link">netty 学习笔记</a></li><li><a href="/yf_blog/pages/1d7cbc/" class="sidebar-link">关于 boolean 类型的坑</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>JVM</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/5bd791/" class="sidebar-link">JVM 自动内存管理</a></li><li><a href="/yf_blog/pages/af8f89/" class="sidebar-link">Linux 中 JVM 常用工具以及常见问题解决思路</a></li><li><a href="/yf_blog/pages/6d59a8/" class="sidebar-link">虚拟机执行子系统</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/ffad26/" class="sidebar-link">Linux 常见命令</a></li><li><a href="/yf_blog/pages/f1c66b/" class="sidebar-link">Linux 文件系统</a></li><li><a href="/yf_blog/pages/a38810/" class="sidebar-link">crontab 表达式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>中间件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/6c5584/" class="sidebar-link">ES 搜索引擎</a></li><li><a href="/yf_blog/pages/99643e/" class="sidebar-link">Grape-RAG</a></li><li><a href="/yf_blog/pages/875de7/" class="sidebar-link">Hadoop 基础原理</a></li><li><a href="/yf_blog/pages/c0a8b3/" class="sidebar-link">flink 提交流程</a></li><li><a href="/yf_blog/pages/aea0b0/" class="sidebar-link">关于定时任务原理</a></li><li><a href="/yf_blog/pages/cadcaf/" class="sidebar-link">详解 kafka</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>多线程</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/39f90e/" class="sidebar-link">AQS 组件</a></li><li><a href="/yf_blog/pages/88b449/" class="sidebar-link">ThreadLocal 原理以及使用</a></li><li><a href="/yf_blog/pages/3cb05b/" class="sidebar-link">多线程基础学习笔记</a></li><li><a href="/yf_blog/pages/590640/" class="sidebar-link">如何手写单例</a></li><li><a href="/yf_blog/pages/815666/" class="sidebar-link">深入理解 java 多线程安全</a></li><li><a href="/yf_blog/pages/0fe2c9/" class="sidebar-link">生产者消费者问题</a></li><li><a href="/yf_blog/pages/152939/" class="sidebar-link">简单了解并发集合</a></li><li><a href="/yf_blog/pages/c3bf74/" aria-current="page" class="active sidebar-link">线程池作用、用法以及原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/yf_blog/pages/c3bf74/#作用" class="sidebar-link">作用</a></li><li class="sidebar-sub-header level2"><a href="/yf_blog/pages/c3bf74/#用法" class="sidebar-link">用法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#建议设定大小" class="sidebar-link">建议设定大小</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#快捷构造线程池" class="sidebar-link">快捷构造线程池</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#submit-与-execute" class="sidebar-link">submit 与 execute</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#shutdown-与-shutdownnow" class="sidebar-link">shutdown 与 shutdownNow</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#future-与-futuretast" class="sidebar-link">Future 与 FutureTast</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#代码" class="sidebar-link">代码</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/yf_blog/pages/c3bf74/#状态-生命周期" class="sidebar-link">状态（生命周期）</a></li><li class="sidebar-sub-header level2"><a href="/yf_blog/pages/c3bf74/#底层原理" class="sidebar-link">底层原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#继承关系" class="sidebar-link">继承关系</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#主要参数" class="sidebar-link">主要参数</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#工作原理" class="sidebar-link">工作原理</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#饱和策略" class="sidebar-link">饱和策略</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#连接复用" class="sidebar-link">连接复用</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/yf_blog/pages/c3bf74/#常见问题" class="sidebar-link">常见问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#死锁" class="sidebar-link">死锁</a></li><li class="sidebar-sub-header level3"><a href="/yf_blog/pages/c3bf74/#forkjoinpool" class="sidebar-link">ForkJoinPool</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>网络</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/043eaf/" class="sidebar-link">CORS 跨域资源共享</a></li><li><a href="/yf_blog/pages/600d20/" class="sidebar-link">DNS、HTTP 与 HTTPS</a></li><li><a href="/yf_blog/pages/7c88d6/" class="sidebar-link">Server-Sent Events (SSE)</a></li><li><a href="/yf_blog/pages/4ac21b/" class="sidebar-link">WebSocket 长连接</a></li><li><a href="/yf_blog/pages/d24c25/" class="sidebar-link">网络安全相关</a></li><li><a href="/yf_blog/pages/84c722/" class="sidebar-link">计算机网络学习笔记</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>非关系型数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/48919a/" class="sidebar-link">Redis 学习笔记</a></li><li><a href="/yf_blog/pages/2c45c8/" class="sidebar-link">Redis 数据结构、对象与数据库</a></li><li><a href="/yf_blog/pages/85c3e5/" class="sidebar-link">Redis 集群</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>其他</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/70a1c3/" class="sidebar-link">程序员职场工作需要注意什么</a></li><li><a href="/yf_blog/pages/895c9e/" class="sidebar-link">梅花易数学习笔记</a></li><li><a href="/yf_blog/pages/636b5c/" class="sidebar-link">观罗翔讲刑法随笔</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Python</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/af8be0/" class="sidebar-link">Python 基础语法</a></li><li><a href="/yf_blog/pages/33367a/" class="sidebar-link">Python 学习</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>问题记录</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/e80dd5/" class="sidebar-link">Liteflow 在 SpringBoot 启动时无法注入组件问题 couldn‘t find chain with the id[THEN(NodeComponent)]</a></li><li><a href="/yf_blog/pages/b2c2ce/" class="sidebar-link">提供可传递的易受攻击的依赖项</a></li><li><a href="/yf_blog/pages/a645d6/" class="sidebar-link">定时任务单线程消费 redis 中数据导致消费能力不足</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>关系型数据库</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/914f14/" class="sidebar-link">B+ 树的插入、删除和数据页分裂机制</a></li><li><a href="/yf_blog/pages/4a3edf/" class="sidebar-link">MySQL 事务与锁与 MVCC</a></li><li><a href="/yf_blog/pages/5c4a79/" class="sidebar-link">MySQL 的 binglog、redolog、undolog</a></li><li><a href="/yf_blog/pages/3003d6/" class="sidebar-link">MySQL 基本的特性</a></li><li><a href="/yf_blog/pages/0417b7/" class="sidebar-link">MySQL 开发规范</a></li><li><a href="/yf_blog/pages/6df0d7/" class="sidebar-link">MySQL 数据类型、字符集相关内容</a></li><li><a href="/yf_blog/pages/3ce13f/" class="sidebar-link">MySQL 索引与索引优化</a></li><li><a href="/yf_blog/pages/111791/" class="sidebar-link">MySQL 的记录存储结构、存储引擎与 Buffer Pool</a></li><li><a href="/yf_blog/pages/c18a31/" class="sidebar-link">PostgreSQL 更新数据时 HOT优化</a></li><li><a href="/yf_blog/pages/a291d2/" class="sidebar-link">PostgreSQL 相关用法</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Spring 项目</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/yf_blog/pages/29a945/" class="sidebar-link">Lombok 的常用注解</a></li><li><a href="/yf_blog/pages/1d4f63/" class="sidebar-link">MyBatis 框架的使用</a></li><li><a href="/yf_blog/pages/4d37fa/" class="sidebar-link">MyBatis 重要知识点总结</a></li><li><a href="/yf_blog/pages/6ff744/" class="sidebar-link">MybatisPlus 的使用</a></li><li><a href="/yf_blog/pages/0a31d8/" class="sidebar-link">Spring IOC 的原理及源码</a></li><li><a href="/yf_blog/pages/a936eb/" class="sidebar-link">Spring 事务相关</a></li><li><a href="/yf_blog/pages/b4b4bd/" class="sidebar-link">Spring 框架基础使用</a></li><li><a href="/yf_blog/pages/9ea3d4/" class="sidebar-link">Spring AOP 的使用和原理</a></li><li><a href="/yf_blog/pages/42070c/" class="sidebar-link">SpringBoot 基础使用</a></li><li><a href="/yf_blog/pages/848eac/" class="sidebar-link">SpringBoot 的原理</a></li><li><a href="/yf_blog/pages/7dfef0/" class="sidebar-link">SpringWeb 重要知识点</a></li><li><a href="/yf_blog/pages/decb90/" class="sidebar-link">maven 小结</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><!----> <div class="info" data-v-06225672><!----> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2021-06-05</a></div> <div title="分类" class="date iconfont icon-wenjian" data-v-06225672><a href="/yf_blog/categories/?category=%E5%A4%9A%E7%BA%BF%E7%A8%8B" data-v-06225672>多线程 </a></div></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">线程池作用、用法以及原理<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h2> <p>1，降低资源消耗。通过重复利用已创建的线程降低线程创建和销毁造成的消耗
2，提高响应速度。当任务到达时，任务可以不需要的等到线程创建就能立即执行
3，提高线程的可管理性。线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控</p> <p>尽量通过 Executor 来启动线程，这种方法比使用 Thread 的 start 方法更好，除了更易管理，效率更好（用线程池实现，节约开销）外，还有关键的一点：有助于避免 this 逃逸问题</p> <h2 id="用法"><a href="#用法" class="header-anchor">#</a> 用法</h2> <p>使用 ThreadPoolExecutor 构造线程池，将线程（任务）传入</p> <p>创建线程池时需要设定特殊参数，如核心线程池大小、最大线程池大小、缓冲队列大小等</p> <p>获取结果也是线程池使用的一大难点，普通的 Future 接口以及 FutureTask、ListenableFuture 等都可以实现接受结果
<img src="https://i-blog.csdnimg.cn/blog_migrate/aab176f46911a4f457824e2dc6ef5ef6.png" alt="在这里插入图片描述"></p> <h3 id="建议设定大小"><a href="#建议设定大小" class="header-anchor">#</a> 建议设定大小</h3> <p>1、CPU 计算较多的时候，被叫做 CPU 密集型应用，核心线程数设置为 N+1，N 为 CPU 个数
2、IO 操作较多时，被叫做 IO 密集型应用，设置为 2*N（IO 所需要的 CPU 资源非常少。大部分工作是分派给 DMA 完成的）</p> <p>我们线上很多场景都不需要 CPU 一直参与，因此设置为 2*N 比较合适</p> <p>那么这个大小到底是如何确定下来的呢？</p> <p>通过 Little's Law（<strong>利特尔法则</strong>）确定的，利特尔法则（Little’s Law）是运营管理中的一个基本定理，由约翰·利特尔（John Little）于1961年提出。 该法则描述了在稳定系统中，系统中的平均库存量（L）、平均到达率（λ）和平均等待时间（W）之间的关系</p> <p>知道三点即可确定线程数：请求 CPU 处理时间、一个请求所消耗的时间、CPU 数目，表示如下：</p> <p><strong>线程数=[(线程等待时间+线程 CPU 时间)/线程 CPU 时间]×CPU 数量</strong> <img src="https://i-blog.csdnimg.cn/blog_migrate/ca7aaeed63ea91cd600601974951e6de.png" alt="在这里插入图片描述">
如何获取线程 CPU 时间和线程等待时间呢，最好的办法是通过性能测试，做好监控、打点、压测来发现最佳的线程数</p> <p>同时也给了我们一个提示，要提升性能我们就要减少 CPU 的执行时间，另外就是要设置一个合理的并发线程数，通过这两方面来显著提升服务器的性能</p> <p>当然以上过程比较理论化，在实战中会有很多特殊情况发生，比如下午3，4点的流量，和 12 点左右午饭时的流量不一样，而美团给出了动态化配置的解决方案</p> <p>在源码中有一些诡异的方法，我们一般不会注意到，比如：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token keyword">int</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>corePoolSize <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> delta <span class="token operator">=</span> corePoolSize <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>corePoolSize <span class="token operator">=</span> corePoolSize<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> corePoolSize<span class="token punctuation">)</span>
            <span class="token function">interruptIdleWorkers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>delta <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// We don't really know how many new threads are &quot;needed&quot;.</span>
            <span class="token comment">// As a heuristic, prestart enough new workers (up to new</span>
            <span class="token comment">// core size) to handle the current number of tasks in</span>
            <span class="token comment">// queue, but stop if queue becomes empty while doing so.</span>
            <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>delta<span class="token punctuation">,</span> workQueue<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>k<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>该方法让我们可以在线程池运行时修改核心线程数</strong>，JDK 不止提供了这个方法，最大线程数等都可以修改</p> <p>同时，我们除了将大小动态化保存，还可以关注最大线程数和核心线程数的大小，如果将核心线程数设置为最佳线程数了，最大的线程数可能需要和核心保持一致，如果将最大线程数设置为最佳线程数，核心线程数可能需要设置为平时的请求 QPS 数来节省资源</p> <h3 id="快捷构造线程池"><a href="#快捷构造线程池" class="header-anchor">#</a> 快捷构造线程池</h3> <p>只建议用 ThreadPoolExecutor 来创建线程池，不建议使用 Executors 中的以下四种方法创建，前两种队列大小可达 INTEGER_VALUE，后两种线程多少可达 INTEGER_VALUE，而这两种都会消耗系统资源，在源码中以下方法也只是返回参数固定的 ThreadPoolExecutor 对象</p> <p>1，FixedThreadPool：固定线程数的线程池
2，SingleThreadExecutor：只有一个线程的线程池
3，CachedThreadPool：主线程提交任务的速度高于线程处理任务的速度时，会不断创建新的线程
4，ScheduledThreadPoolExecutor：定时执行任务</p> <h3 id="submit-与-execute"><a href="#submit-与-execute" class="header-anchor">#</a> submit 与 execute</h3> <p>submit 可以提交 Callable 子类对象并获得一个 Future 类型的对象，比如 FutrueTask 作为返回值。可以通过 Future 的 get 方法来获取返回值，不过 get 会阻塞调用该方法的线程，因此是同步的，get 方法可以带时间，时间一过就会抛出异常。这种方式在调用 future 的 get 方法时才会抛出异常</p> <p>execute 方法用于提交不需要返回值的任务，所以无法判断任务是否被线程池执行成功与否，同时由于 Runnable 的 run 方法没有抛出异常，因此 Runnable 实现的线程也不会抛出异常，我们需要在内部捕获异常</p> <h3 id="shutdown-与-shutdownnow"><a href="#shutdown-与-shutdownnow" class="header-anchor">#</a> shutdown 与 shutdownNow</h3> <p>shutdown：关闭线程池，线程池的状态变为 SHUTDOWN，不再接受新任务，并执行所有在队列中的任务</p> <p>shutdownNow：立即关闭线程池，线程池的状态变为 STOP，停止执行所有任务，返回在队列中的任务链表</p> <p>同时，还有 isShutdown() 方法与 isTerminated() 方法来判断它是否执行 shutdown 方法以及是否抛出了所有队列进入了 terminated 状态</p> <h3 id="future-与-futuretast"><a href="#future-与-futuretast" class="header-anchor">#</a> Future 与 FutureTast</h3> <p>Future 是一个接口，里面定义了一些方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">boolean</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> mayInterruptIfRunning<span class="token punctuation">)</span><span class="token punctuation">;</span>如果任务已经启动，执行<span class="token function">cancel</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>方法将以中断执行此任务线程的方式来试图停止任务
<span class="token keyword">boolean</span> <span class="token function">isCancelled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">boolean</span> <span class="token function">isDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">V</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>FutureTask 除了实现了 Future 接口外还实现了 Runnable 接口（即可以通过 Runnable 接口实现线程，也可以通过 Future 取得线程执行完后的结果），因此 FutureTask 也可以直接提交给 Executor 执行</p> <h3 id="代码"><a href="#代码" class="header-anchor">#</a> 代码</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> test4 <span class="token punctuation">{</span>
	
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CORE_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">MAX_POOL_SIZE</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">QUEUE_CAPACITY</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Long</span> <span class="token constant">KEEP_ALIVE_TIME</span> <span class="token operator">=</span> <span class="token number">1L</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    	<span class="token class-name">TreadTest</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TreadTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                <span class="token constant">CORE_POOL_SIZE</span><span class="token punctuation">,</span>
                <span class="token constant">MAX_POOL_SIZE</span><span class="token punctuation">,</span>
                <span class="token constant">KEEP_ALIVE_TIME</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token constant">QUEUE_CAPACITY</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//        	TreadTest t = new TreadTest();</span>
        	executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">isTerminated</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finished all threads&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">TreadTest</span> <span class="token keyword">implements</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
	<span class="token keyword">volatile</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Thread Name= &quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;number = &quot;</span><span class="token operator">+</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token keyword">try</span> <span class="token punctuation">{</span>
	            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	        <span class="token punctuation">}</span>
    	<span class="token punctuation">}</span>
        <span class="token comment">//formatter pattern is changed here by thread, but it won't reflect to other threads</span>
        <span class="token keyword">return</span> j<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br></div></div><h2 id="状态-生命周期"><a href="#状态-生命周期" class="header-anchor">#</a> 状态（生命周期）</h2> <p>线程池有5种状态</p> <p>1，RUNNING：线程池一旦被创建，就处于 RUNNING 状态，任务数为0，能够接收新任务，对已排队的任务进行处理</p> <p>2，SHUTDOWN：<strong>不接收新任务，但能处理已排队的任务</strong>。调用线程池的 shutdown 方法，线程池由 RUNNING 转变为 SHUTDOWN 状态，只有在所有任务执行完毕后，空闲的线程才会被逐渐回收</p> <p>3，STOP：不接收新任务，不处理已排队的任务，如果还有未完成的任务，这些任务将会被丢弃，并且会中断正在处理的任务。调用线程池的 shutdownNow 方法，线程池由 RUNNING 或 SHUTDOWN 转变为 STOP 状态，被中断的线程在完成任务后会被回收，因为线程池正在关闭</p> <p>4，TIDYING（整理）：</p> <p>SHUTDOWN 状态下，任务数为 0，其他所有任务已终止，线程池会变为 TIDYING 状态，会执行 terminated 方法。线程池中的 terminated 方法是空实现，可以重写该方法进行相应的处理，用于在线程池停止后执行一些清理工作</p> <p>线程池在 STOP 状态，线程池中执行中任务为空时，就会由 STOP 转变为 TIDYING 状态</p> <p>5，TERMINATED（结束）：线程池彻底终止。线程池在 TIDYING 状态执行完 terminated 方法就会由 TIDYING 转变为 TERMINATED 状态</p> <p><img src="https://i-blog.csdnimg.cn/blog_migrate/1c40282b271f49e69b4e7b6be3ebb333.png" alt="在这里插入图片描述"></p> <h2 id="底层原理"><a href="#底层原理" class="header-anchor">#</a> 底层原理</h2> <h3 id="继承关系"><a href="#继承关系" class="header-anchor">#</a> 继承关系</h3> <p>如果加入已计划的线程池，就成了如下结果：
<img src="https://i-blog.csdnimg.cn/blog_migrate/fedd3f6bee6edfb0292678928d107a00.png" alt="在这里插入图片描述">
ScheduledExecutorService 主要是用来做定时任务的</p> <p>以下是 ExecutorService 接口的所有方法（Execute 接口只有一个 execute 方法）
<img src="https://i-blog.csdnimg.cn/blog_migrate/c9e7c4b1d4f97417555bcd3cd8843fbd.png" alt="在这里插入图片描述">
可以看到该接口就是表示了线程池的生命周期，这个线程池服务的 invokeAll 方法是将集合中所有的Callable都执行，invokeAny提交所有但是只返回一个最先完成的结果，其他的主要方法下面会说</p> <p>以下源码主要来自ThreadPoolExecutor类</p> <h3 id="主要参数"><a href="#主要参数" class="header-anchor">#</a> 主要参数</h3> <p>corePoolSize：核心线程数，线程池有多少线程同时运行</p> <p>maximumPoolSize：最大线程数，当提交的任务超过队列大小时，当前可以同时运行的线程数量变为最大线程数</p> <p>workQueue：缓冲队列，指最大可以存放的任务数，注意，线程执行任务时任务还在队列中，可以把缓冲队列设置为0看看效果</p> <p>handler：饱和策略，如果缓冲队列慢了会怎么处理提交的任务</p> <p>keepAliveTime：如果线程没有任务，多少时间后会消亡</p> <p>注意，缓冲队列和饱和策略都是可以继承后重写的，你可以在饱和策略里发mq，Tomcat 中也重写了队列，为了优先创建线程</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// Tomcat的TaskQueue核心逻辑</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TaskQueue</span> <span class="token keyword">extends</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> o<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果线程数未达到最大线程数，直接拒绝入队，让线程池创建新线程</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span><span class="token function">getPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> parent<span class="token punctuation">.</span><span class="token function">getMaximumPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 触发创建新线程</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">offer</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">offer</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 同样逻辑</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>现在我们来构建一个线程池：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExample</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 创建线程池</span>
        <span class="token class-name">ThreadPoolExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
         	<span class="token comment">// 核心线程数</span>
            <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token comment">// 最大线程数</span>
            <span class="token number">10</span><span class="token punctuation">,</span>
            <span class="token comment">// 空闲线程的存活时间</span>
            <span class="token number">60L</span><span class="token punctuation">,</span>
            <span class="token comment">// 时间单位，分钟</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">,</span>
            <span class="token comment">// 有界任务队列，如果需要无界任务队列，使用 new ArrayBlockingQueue&lt;Runnable&gt;() 即可</span>
            <span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">// 拒绝策略，如果队列满了，使用主线程来处理这个任务</span>
            <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 提交任务</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token keyword">int</span> taskId <span class="token operator">=</span> i<span class="token punctuation">;</span>
            executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Task ID: &quot;</span> <span class="token operator">+</span> taskId <span class="token operator">+</span> <span class="token string">&quot; is running by &quot;</span> <span class="token operator">+</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 模拟任务执行时间</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">interrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Task ID: &quot;</span> <span class="token operator">+</span> taskId <span class="token operator">+</span> <span class="token string">&quot; was interrupted&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 关闭线程池</span>
        executor<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">awaitTermination</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                executor<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            executor<span class="token punctuation">.</span><span class="token function">shutdownNow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h3> <p>1，核心线程数未满时，提交任务，无可用线程时线程数加一
2，核心线程数已满时，提交任务，到达缓冲队列
3，缓冲队列已满时，提交任务，创建新线程直到到达最大线程数
4，继续提交任务，线程池使用饱和策略，饱和策略可以在构造线程池时设定</p> <p>以上四步也是 ThreadPoolExecutor 的 execute 方法的过程</p> <p>但是在开始之前需要来一点预备知识</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token comment">// ctl 表示了线程的状态以及当前激活的线程数，用一个值表示了两种东西，很离谱对不对</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> ctl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token constant">RUNNING</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Integer.SIZE 就是32，COUNT_BITS 就是29</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">COUNT_BITS</span> <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token constant">SIZE</span> <span class="token operator">-</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CAPACITY</span>   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// 这里就是线程池运行时状态</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RUNNING</span>    <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">SHUTDOWN</span>   <span class="token operator">=</span>  <span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STOP</span>       <span class="token operator">=</span>  <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TIDYING</span>    <span class="token operator">=</span>  <span class="token number">2</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TERMINATED</span> <span class="token operator">=</span>  <span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">COUNT_BITS</span><span class="token punctuation">;</span>

    <span class="token comment">// 提供读取当前线程数、当前运行状态的方法</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>     <span class="token punctuation">{</span> <span class="token keyword">return</span> c <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token constant">CAPACITY</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span>  <span class="token punctuation">{</span> <span class="token keyword">return</span> c <span class="token operator">&amp;</span> <span class="token constant">CAPACITY</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ctlOf</span><span class="token punctuation">(</span><span class="token keyword">int</span> rs<span class="token punctuation">,</span> <span class="token keyword">int</span> wc<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> rs <span class="token operator">|</span> wc<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>来解释一下，ctl 的低29位用于存放当前的线程数，因此一个线程池在理论上最大的线程数是(2^29)-1；高3位是用于表示当前线程池的状态，其中高三位的值和状态对于如下：</p> <ul><li>111: RUNNING</li> <li>000: SHUTDOWN</li> <li>001: STOP</li> <li>010: TIDYING</li> <li>011: TERMINATED</li></ul> <p>在以后的处理需要多个数据的问题的时候，也可以模仿这种优雅的写法。接下来来看看 execute 方法</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ctl 是个原子类，拿到ctl的值</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 如果核心线程数大于现在正在执行的线程数，workerCountOf方法用于获取当前正在执行的线程数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	<span class="token comment">// 调用addWorker创建一个线程并返回，如果创建失败再获取一个ctl</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果当前线程池在跑并且将command成功加入了队列</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isRunning</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> workQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> recheck <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果当前线程池没在跑并且将command删除成功了，则执行拒绝策略</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token function">isRunning</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">remove</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果发生什么事情删除失败了或者当前线程池在运行中，则会判断工作线程是否为0 ，如果过为0 就创建一个非核心线程</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>recheck<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 尝试创建一个工作线程，如果线程池挂了或者大于最大线程数，执行拒绝策略</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 其他情况不做处理</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>其中 addWorker 方法用于创建新线程，它使用 HashSet 来存放线程，里面放的是 Worker，只有持有全局锁 mainLock 的前提下才能访问此集合。同时这个方法返回 true 则表示线程创建成功，false 表示失败</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 线程池的最大大小</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> largestPoolSize<span class="token punctuation">;</span>
    <span class="token comment">// 工作线程放在这里</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Worker</span><span class="token punctuation">&gt;</span></span> workers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> core<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   		<span class="token comment">//这个retry用于跳出两层循环，两次循环创建失败后再次进行资格判断</span>
        retry<span class="token operator">:</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        	<span class="token comment">//条件判断</span>
            <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&gt;=</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span>
                <span class="token operator">!</span> <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span>
                   firstTask <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>
                   <span class="token operator">!</span> workQueue<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

			<span class="token comment">//以下for循环主要为了将workcount的数量加1</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">//获取线程池中工作的线程的数量</span>
                <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// core参数为true的话表明队列也满了，线程池大小变为 maximumPoolSize</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>wc <span class="token operator">&gt;=</span> <span class="token constant">CAPACITY</span> <span class="token operator">||</span>
                    wc <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>core <span class="token operator">?</span> corePoolSize <span class="token operator">:</span> maximumPoolSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
               <span class="token comment">//原子操作将workcount的数量加1</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndIncrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">break</span> retry<span class="token punctuation">;</span>
                <span class="token comment">// 如果线程的状态改变了就再次执行上述操作</span>
                c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">runStateOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">!=</span> rs<span class="token punctuation">)</span>
                    <span class="token keyword">continue</span> retry<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 标记工作线程是否启动成功</span>
        <span class="token keyword">boolean</span> workerStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">// 标记工作线程是否创建成功</span>
        <span class="token keyword">boolean</span> workerAdded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token class-name">Worker</span> w <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//以下过程尝试去创建工作线程</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            w <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Worker</span><span class="token punctuation">(</span>firstTask<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">Thread</span> t <span class="token operator">=</span> w<span class="token punctuation">.</span>thread<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 加锁</span>
                <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> mainLock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mainLock<span class="token punctuation">;</span>
                mainLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">//获取线程池状态</span>
                    <span class="token keyword">int</span> rs <span class="token operator">=</span> <span class="token function">runStateOf</span><span class="token punctuation">(</span>ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//rs &lt; SHUTDOWN 如果线程池状态依然为RUNNING,并且线程的状态是存活的话，就会将工作线程添加到工作线程集合中</span>
                    <span class="token comment">//(rs=SHUTDOWN &amp;&amp; firstTask == null)如果线程池状态小于STOP，也就是RUNNING或者SHUTDOWN状态下，同时传入的任务实例firstTask为null，则需要添加到工作线程集合和启动新的Worker</span>
                    <span class="token comment">// firstTask == null证明只新建线程而不执行任务</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rs <span class="token operator">&lt;</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">||</span>
                        <span class="token punctuation">(</span>rs <span class="token operator">==</span> <span class="token constant">SHUTDOWN</span> <span class="token operator">&amp;&amp;</span> firstTask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">isAlive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// precheck that t is startable</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        workers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//更新当前工作线程的最大容量</span>
                        <span class="token keyword">int</span> s <span class="token operator">=</span> workers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;</span> largestPoolSize<span class="token punctuation">)</span>
                            largestPoolSize <span class="token operator">=</span> s<span class="token punctuation">;</span>
                        <span class="token comment">// 工作线程是否启动成功</span>
                        workerAdded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    mainLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 如果成功添加工作线程，则调用Worker内部的线程实例t的Thread#start()方法启动真实的线程实例</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    t<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 标记线程启动成功</span>
                    workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// 线程启动失败，需要从工作线程中移除对应的Worker</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> workerStarted<span class="token punctuation">)</span>
                <span class="token function">addWorkerFailed</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> workerStarted<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><h3 id="饱和策略"><a href="#饱和策略" class="header-anchor">#</a> 饱和策略</h3> <p>1，拒绝执行任务并抛出异常
2，使用调用线程池的线程执行任务
3，丢弃此任务
4，丢弃第一个等待的任务</p> <p>还有更多处理方法，可以自行百度</p> <h3 id="连接复用"><a href="#连接复用" class="header-anchor">#</a> 连接复用</h3> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">Runnable</span> <span class="token function">getTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">boolean</span> timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> wc <span class="token operator">=</span> <span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// wc &gt; corePoolSize，表示当前线程池中的线程数量大于核心线程数量；</span>
        <span class="token comment">// 对于超过核心线程数量的这些线程，需要进行超时控制</span>
        <span class="token keyword">boolean</span> timed <span class="token operator">=</span> allowCoreThreadTimeOut <span class="token operator">||</span> wc <span class="token operator">&gt;</span> corePoolSize<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>timed <span class="token operator">&amp;&amp;</span> timedOut<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 如果需要进行超时控制，且上次从缓存队列中获取任务时发生了超时，那么尝试将workerCount减1,即当前活动线程数减1，</span>
            <span class="token comment">// 如果减1成功，则返回null，这就意味着runWorker()方法中的while循环会被退出，其对应的线程就要销毁了，也就是线程池中少了一个线程了</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareAndDecrementWorkerCount</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Runnable</span> r <span class="token operator">=</span> timed <span class="token operator">?</span>
                workQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>keepAliveTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">NANOSECONDS</span><span class="token punctuation">)</span> <span class="token operator">:</span>
                workQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 注意workQueue中的poll()方法与take()方法的区别</span>
            <span class="token comment">// poll方式取任务的特点是从缓存队列中取任务,最长等待keepAliveTime的时长，取不到返回null</span>
            <span class="token comment">// take方式取任务的特点是从缓存队列中取任务，若队列为空,则进入阻塞状态，直到能取出对象为止</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> r<span class="token punctuation">;</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> retry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            timedOut <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>上面的代码实现了连接池的线程复用，以及超过核心线程数的线程如何被销毁，核心线程如何被保存，思路就是把 Runnable 放进 BlockingQueue 里，用一定方式调用线程去拿任务</p> <p>如果当前活动线程数大于核心线程数，当去缓存队列中取任务的时候，如果缓存队列中没任务了，则等待 keepAliveTime 的时长，此时还没任务就返回 null，这就意味着 runWorker() 方法中的 while 循环会被退出，其对应的线程就要销毁了，也就是线程池中少了一个线程了。因此只要线程池中的线程数大于核心线程数就会这样一个一个地销毁这些多余的线程</p> <p>如果当前活动线程数小于等于核心线程数，同样也是去缓存队列中取任务，但当缓存队列中没任务了，就会进入阻塞状态，直到能取出任务为止，因此这个线程是处于阻塞状态的，并不会因为缓存队列中没有任务了而被销毁。这样就保证了线程池有 N 个线程是活的，可以随时处理任务，从而达到重复利用的目的</p> <p>所以最大线程与核心线程的不同，就是调用获取任务的方法不同，一个 take 一个是 poll，这两个方法都由 BlockingQueue 友情提供</p> <h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <h3 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h3> <p>虽然死锁可能发生在任何多线程程序中，但线程池引入了另一种死锁情况。他发生死锁的原因是线程池中执行 A 函数，A 函数阻塞的调用 B 函数，而 B 函数也在该线程池中，其中所有正在执行的线程都在<strong>等待等待队列阻塞线程的结果</strong>，因为执行的线程不可用</p> <p>业务线程在占用了线程池内所有的资源后又向线程池提交了新的任务，并且要等这些任务完成后才释放资源，而这些新提交的任务根本就没机会被完成</p> <p>如果我们使用无界线程池，死锁的问题几乎无法解决，因为我们不断提交任务，但是线程池却不扩容，最后导致所有的线程都无法执行</p> <h3 id="forkjoinpool"><a href="#forkjoinpool" class="header-anchor">#</a> ForkJoinPool</h3> <p>ForkJoinPool 不是为了替代 ExecutorService，而是它的补充，在某些应用场景下性能比 ExecutorService 更好。ForkJoinPool 主要用于实现分而治之的场景，需要程序员去将任务拆分，它最适合的是计算密集型的任务</p> <p>其性能好坏取决于编码方式，举个例子</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ForkJoinCalculator</span> <span class="token keyword">implements</span> <span class="token class-name">Calculator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ForkJoinPool</span> pool<span class="token punctuation">;</span>

    <span class="token comment">//执行任务RecursiveTask：有返回值  RecursiveAction：无返回值</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SumTask</span> <span class="token keyword">extends</span> <span class="token class-name">RecursiveTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> from<span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token keyword">to</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token class-name">SumTask</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">,</span> <span class="token keyword">int</span> from<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token keyword">to</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>numbers <span class="token operator">=</span> numbers<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>from <span class="token operator">=</span> from<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token keyword">to</span> <span class="token operator">=</span> <span class="token keyword">to</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//此方法为ForkJoin的核心方法：对任务进行拆分  拆分的好坏决定了效率的高低</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">protected</span> <span class="token class-name">Long</span> <span class="token function">compute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// 当需要计算的数字个数小于6时，直接采用for loop方式计算结果</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">to</span> <span class="token operator">-</span> from <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">long</span> total <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> from<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token keyword">to</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    total <span class="token operator">+=</span> numbers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> total<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 否则，把任务一分为二，递归拆分(注意此处有递归)到底拆分成多少分 需要根据具体情况而定</span>
                <span class="token keyword">int</span> middle <span class="token operator">=</span> <span class="token punctuation">(</span>from <span class="token operator">+</span> <span class="token keyword">to</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token class-name">SumTask</span> taskLeft <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SumTask</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> from<span class="token punctuation">,</span> middle<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SumTask</span> taskRight <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SumTask</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> middle <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">to</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                taskLeft<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                taskRight<span class="token punctuation">.</span><span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> taskLeft<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> taskRight<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ForkJoinCalculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 也可以使用公用的线程池 ForkJoinPool.commonPool()：</span>
        <span class="token comment">// pool = ForkJoinPool.commonPool()</span>
        pool <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ForkJoinPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">sumUp</span><span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> numbers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Long</span> result <span class="token operator">=</span> pool<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SumTask</span><span class="token punctuation">(</span>numbers<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> numbers<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pool<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
输出：
耗时：<span class="token number">390</span>ms
结果为：<span class="token number">50000005000000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div></div></div> <!----> <div class="page-edit"><!----> <div class="tags"><a href="/yf_blog/tags/?tag=%E7%BA%BF%E7%A8%8B%E6%B1%A0" title="标签">#线程池</a><a href="/yf_blog/tags/?tag=%E5%B9%B6%E5%8F%91" title="标签">#并发</a></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">1/17/2026, 1:51:19 AM</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/yf_blog/pages/152939/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">简单了解并发集合</div></a> <a href="/yf_blog/pages/043eaf/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">CORS 跨域资源共享</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/yf_blog/pages/152939/" class="prev">简单了解并发集合</a></span> <span class="next"><a href="/yf_blog/pages/043eaf/">CORS 跨域资源共享</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/yf_blog/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/yf_blog/pages/221c1a/"><div>
            关于分布式系统 RPC 中高可用功能的实现
            <!----></div></a> <span class="date">01-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/yf_blog/pages/e7adfb/"><div>
            VuePress 博客搭建指南
            <!----></div></a> <span class="date">01-03</span></dt></dl><dl><dd>03</dd> <dt><a href="/yf_blog/pages/4d4c8e/"><div>
            Vercel 部署教程
            <!----></div></a> <span class="date">01-02</span></dt></dl> <dl><dd></dd> <dt><a href="/yf_blog/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> <!----></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/yf_blog/assets/js/app.63605832.js" defer></script><script src="/yf_blog/assets/js/3.86e8edc4.js" defer></script><script src="/yf_blog/assets/js/2.e5572c9a.js" defer></script><script src="/yf_blog/assets/js/158.608e9bf5.js" defer></script>
  </body>
</html>
